<div [formGroup]="form" class="msg91-query-builder d-flex">
    <!-- <ul *ngIf="form.controls && form.get('rules')"> -->
    <ul *ngIf="form.controls && form.get('rules')" class="p-0 w-100">
        <ng-container *ngFor="let control of form.get('rules')?.controls; let i = index">
            <ng-container
                *ngIf="{
                    isRuleSet: !!control.get('rules')?.controls,
                    isRuleSetHasRule: control.get('rules')?.controls?.length === 0,
                } as checks"
            >
                <div class="d-flex align-items-start msg91-query-builder-row">
                    <ng-container
                        [ngTemplateOutlet]="condition"
                        [ngTemplateOutletContext]="{
                            $implicit: form,
                            class: 'mr-3 width-md-70 select-form-field-medium',
                            index: i,
                        }"
                    ></ng-container>
                    <span
                        class="mr-3 mat-body-2 text-dark"
                        style="width: 70px; min-width: 70px"
                        *ngIf="i === 0 && control.get('isRuleSet')?.value"
                    >
                        Where
                    </span>
                    <li
                        [ngClass]="{
                            'rule-set rounded-4 mb-2': control.get('isRuleSet')?.value,
                            'px-2': control.get('isRuleSet')?.value,
                        }"
                        class="align-items-center w-100"
                    >
                        <div *ngIf="control.get('isRuleSet')?.value" class="py-2">
                            <ng-container
                                [ngTemplateOutlet]="addConditionButtonForRuleSet"
                                [ngTemplateOutletContext]="{
                                    $implicit: control,
                                    ruleSetIndex: i,
                                    message: control.get('rules')?.length
                                        ? (control.get('condition').value === 'and' ? 'All' : 'Any') +
                                          ' of the following are trueâ€¦'
                                        : 'Add condition to this group',
                                    disable: control.get('rules').length > 0 && control.get('rules').invalid,
                                }"
                            ></ng-container>
                            <!-- <ng-container *ngIf="checks.isRuleSetHasRule" [ngTemplateOutlet]="defaultEmptyWarning"></ng-container> -->
                        </div>
                        <ng-container *ngIf="!checks.isRuleSet">
                            <div class="d-flex align-items-center mb-2">
                                <span
                                    class="mr-3 mat-body-2 text-dark"
                                    style="width: 70px; min-width: 70px"
                                    *ngIf="i === 0"
                                    >Where</span
                                >
                                <div class="d-flex border rounded-4 rule-set-form-field">
                                    <ng-container
                                        [ngTemplateOutlet]="fieldForm"
                                        [ngTemplateOutletContext]="{
                                            $implicit: control,
                                            fields: (fields$ | async),
                                        }"
                                    >
                                    </ng-container>
                                    <ng-container
                                        [ngTemplateOutlet]="operatorForm"
                                        [ngTemplateOutletContext]="{
                                            $implicit: control,
                                        }"
                                    >
                                    </ng-container>
                                    <ng-container
                                        *ngIf="
                                            (control.get('type')?.value ?? '' | lowercase) === 'object' &&
                                            !control.get('operator')?.value
                                        "
                                        [ngTemplateOutlet]="nestedObjectOperator"
                                        [ngTemplateOutletContext]="{
                                            $implicit: control,
                                        }"
                                    >
                                    </ng-container>
                                    <ng-container
                                        *ngIf="control.get('value')"
                                        [ngTemplateOutlet]="inputForm"
                                        [ngTemplateOutletContext]="{
                                            $implicit: control,
                                        }"
                                    >
                                    </ng-container>
                                    <ng-container *ngIf="i !== 0">
                                        <button
                                            mat-icon-button
                                            color="warn"
                                            class="rounded-0 rule-set-field rule-set-icon-button"
                                            (click)="removeRule(control.parent, i)"
                                        >
                                            <mat-icon class="material-icons-outlined mat-icon-18">delete</mat-icon>
                                        </button>
                                    </ng-container>
                                </div>
                            </div>
                        </ng-container>
                        <ng-container *ngIf="checks.isRuleSet">
                            <msg91-query-builder [form]="control" [config]="config" class="px-2 d-block">
                            </msg91-query-builder>
                        </ng-container>
                    </li>
                </div>
            </ng-container>
        </ng-container>
    </ul>
</div>

<ng-template #condition let-control let-class="class" let-index="index">
    <msg91-mat-select
        *ngIf="index === 1"
        [control]="control.get('condition')"
        [options]="conditionOptions"
        [keyToUseShowLabel]="'label'"
        [class]="class"
        [showError]="false"
    >
    </msg91-mat-select>
    <span *ngIf="index > 1" [class]="class + ' px-2 py-1'" style="height: 32.58px">{{
        control.get('condition').value
    }}</span>
</ng-template>

<ng-template #fieldForm let-control let-fields="fields">
    <!-- <div> -->
    <msg91-mat-select
        [control]="control.get('field')"
        [options]="fields"
        [keyToUseShowLabel]="'name'"
        (onChange)="fieldChange($event, control)"
        [class]="'remove-form-field-border'"
        class="rule-set-field"
        [showError]="false"
        [withPreviousValueInOnChange]="true"
        [enableSearch]="false"
    >
    </msg91-mat-select>
    <!-- </div> -->
</ng-template>
<ng-template #operatorForm let-control>
    <!-- <div> -->
    <msg91-mat-select
        [control]="control.get('operator')"
        [options]="config.fields?.[control.get('field')?.value]?.operators"
        [keyToUseShowLabel]="'label'"
        [keyToUseForValue]="'mathematical_symbol'"
        (onChange)="operatorChange($event, control)"
        [class]="'remove-form-field-border'"
        class="rule-set-field"
        [showError]="false"
    >
    </msg91-mat-select>
    <!-- </div> -->
</ng-template>
<ng-template #nestedObjectOperator let-control>
    <msg91-mat-input
        [control]="control.get('path')"
        [placeholder]="'Eg. key_name1.key_name2'"
        [class]="'remove-form-field-border'"
        class="rule-set-field"
        [showError]="false"
    >
    </msg91-mat-input>
    <msg91-mat-select
        [control]="control.get('suboperator')"
        [options]="config.fields?.[control.get('field')?.value]?.operators[2].operators"
        [keyToUseShowLabel]="'label'"
        [keyToUseForValue]="'mathematical_symbol'"
        [class]="'remove-form-field-border'"
        class="rule-set-field"
        [showError]="false"
        [placeholder]="'select operator'"
        (onChange)="subOperatorChange($event, control)"
    >
        <!-- (onChange)="operatorChange($event, control)" -->
    </msg91-mat-select>
</ng-template>
<ng-template #inputForm let-control>
    <div
        class="rule-set-field"
        [ngSwitch]="
            showInputTextForcefully.includes(control.get('operator')?.value)
                ? 'text'
                : (control.get('type')?.value | lowercase)
        "
        *ngIf="!hideInput?.includes(control?.get('operator')?.value)"
    >
        <!-- No need check because we direct remove value control if operator is on of hideInput class variable -->
        <!-- *ngIf="!hideInput?.includes(control?.get('operator')?.value)" -->
        <ng-container *ngSwitchCase="'string'">
            <msg91-mat-input
                [control]="control.get('value')"
                [placeholder]="'Enter a value'"
                [class]="'remove-form-field-border'"
                [showError]="false"
            >
            </msg91-mat-input>
        </ng-container>
        <ng-container *ngSwitchCase="'text'">
            <msg91-mat-input
                [control]="control.get('value')"
                [placeholder]="'Enter a value'"
                [class]="'remove-form-field-border'"
                [showError]="false"
            >
            </msg91-mat-input>
        </ng-container>
        <ng-container *ngSwitchCase="'email'">
            <msg91-mat-input
                [control]="control.get('value')"
                [placeholder]="'Enter a email'"
                [class]="'remove-form-field-border'"
                [showError]="false"
            >
            </msg91-mat-input>
        </ng-container>
        <ng-container *ngSwitchCase="'number'">
            <msg91-mat-input
                [control]="control.get('value')"
                [placeholder]="'Enter a value'"
                [type]="'number'"
                [class]="'remove-form-field-border'"
                [showError]="false"
            >
            </msg91-mat-input>
        </ng-container>
        <ng-container *ngSwitchCase="'decimal'">
            <msg91-mat-input
                [control]="control.get('value')"
                [placeholder]="'Enter a value'"
                [type]="'number'"
                [class]="'remove-form-field-border'"
                [showError]="false"
            >
            </msg91-mat-input>
        </ng-container>
        <ng-container *ngSwitchCase="'needToImplementDate'">
            <msg91-mat-input
                [control]="control.get('value')"
                [placeholder]="'Enter a value'"
                [type]="'number'"
                [class]="'remove-form-field-border'"
                [showError]="false"
            >
            </msg91-mat-input>
        </ng-container>
        <ng-container *ngSwitchCase="'percentage'">
            <!-- <div class="d-flex align-items-center"> -->
            <msg91-mat-input
                [control]="control.get('value')"
                [placeholder]="'Enter a percentage'"
                [type]="'number'"
                [class]="'remove-form-field-border'"
                [showError]="false"
                [icon]="{
                    string: 'percent',
                    isSuffix: true,
                }"
            >
            </msg91-mat-input>
            <!-- </div> -->
        </ng-container>
        <ng-container *ngSwitchCase="'phone number'">
            <msg91-mat-input
                [control]="control.get('value')"
                [placeholder]="'Enter a phone number'"
                [type]="'number'"
                [class]="'remove-form-field-border'"
                [showError]="false"
            >
            </msg91-mat-input>
        </ng-container>
        <ng-container *ngSwitchCase="'object'">
            <msg91-mat-input
                [control]="control.get('value')"
                [placeholder]="'Enter a value'"
                [class]="'remove-form-field-border'"
                [showError]="false"
            >
            </msg91-mat-input>
        </ng-container>
        <ng-container *ngSwitchCase="'formula'">
            <msg91-mat-input
                [control]="control.get('value')"
                [placeholder]="'Enter a value'"
                [class]="'remove-form-field-border'"
                [showError]="false"
            >
            </msg91-mat-input>
        </ng-container>
        <ng-container *ngSwitchCase="'date'">
            <div class="d-flex align-items-center">
                <ng-container
                    [ngTemplateOutlet]="dateInputType"
                    [ngTemplateOutletContext]="{
                        $implicit: control,
                    }"
                ></ng-container>
            </div>
        </ng-container>
        <ng-container *ngSwitchCase="'currency'">
            <div class="d-flex align-items-center">
                <msg91-mat-input
                    [control]="control.get('value')"
                    [placeholder]="'Enter currency'"
                    [type]="'number'"
                    [class]="'remove-form-field-border'"
                    [showError]="false"
                    [icon]="{
                        string:
                            fields$
                            | async
                            | fieldValuePipe: control.get('field').value : 'configurations.setup.fields.currency_code',
                        spanString: true,
                    }"
                >
                </msg91-mat-input>
            </div>
        </ng-container>
    </div>
</ng-template>

<ng-template #dateInputType let-control>
    <ng-container *ngIf="externallyShowInputNumber.includes(control.get('operator').value); else date">
        <msg91-mat-input
            [control]="control.get('value')"
            [placeholder]="'Enter a number'"
            [type]="'number'"
            [tooltipMessage]="
                !externallyShowDropDown.includes(control.get('operator').value)
                    ? 'Minimum allowed value is 1'
                    : 'Allowed value in range between : 1, to 1000000000'
            "
            [class]="'remove-form-field-border'"
            class="rule-set-field"
            [showError]="false"
        >
            <!-- [tooltipDisabled]="control.get('value').valid" -->
        </msg91-mat-input>
        <msg91-mat-select
            *ngIf="externallyShowDropDown.includes(control.get('operator').value)"
            [control]="control.get('secondaryoperator')"
            [options]="metaKeyValue?.[control.get('operator').value]"
            [keyToUseShowLabel]="'label'"
            [keyToUseForValue]="'value'"
            [placeholder]="'Select duration'"
            [showError]="false"
            [class]="'remove-form-field-border'"
        >
        </msg91-mat-select>
    </ng-container>
    <ng-template #date>
        <msg91-mat-datepicker
            [control]="control.get('value')"
            [showError]="false"
            [useControlInForm]="false"
            (dateChange)="onDateChange($event, control)"
            [showError]="false"
            [class]="'remove-form-field-border'"
            [readonly]="true"
            [openOnFocus]="true"
        >
        </msg91-mat-datepicker>
    </ng-template>
</ng-template>

<ng-template #extraValueShowEnd let-control>
    <span *ngIf="control.get('type').value === 'currency'" class="mat-body-2 text-dark extra-span">
        {{ fields$ | async | fieldValuePipe: control.get('field').value : 'configurations.setup.fields.currency_code' }}
    </span>
    <span *ngIf="control.get('type').value === 'percentage'" class="mat-body-2 text-dark extra-span"> % </span>
</ng-template>

<ng-template
    #addConditionButtonForRuleSet
    let-parent
    let-message="message"
    let-ruleSetIndex="ruleSetIndex"
    let-disable="disable"
>
    <div class="d-flex align-items-center justify-content-between px-2 rule-set-head">
        <div class="mat-body-2">
            {{ message ?? 'Add Condition to this group' }}
        </div>
        <div class="d-flex gap-1">
            <button mat-icon-button class="icon-btn-md" color="primary" [matMenuTriggerFor]="menu" [disabled]="disable">
                <mat-icon class="material-icons-outlined mat-icon-18">add</mat-icon>
            </button>
            <mat-menu #menu="matMenu" class="more-menu">
                <button mat-menu-item (click)="addRule(parent)">Add Condition</button>
                <button mat-menu-item (click)="addRuleSet(parent)">Add Condition Group</button>
            </mat-menu>
            <button
                mat-icon-button
                color="warn"
                class="icon-btn-md"
                (click)="removeRuleSet(parent.parent, ruleSetIndex)"
            >
                <mat-icon class="material-icons-outlined">delete</mat-icon>
            </button>
        </div>
    </div>
</ng-template>

<ng-template #defaultEmptyWarning let-checks>
    <p class="text-align-center">A group condition cannot be empty. Please add a condition or remove it all together</p>
</ng-template>
